environment:
  GitHubAccessToken:
    secure: vpFm+bVGaeyr4e2n5Tr2Dbozp8/v/mgBplu1j7b1WIC5LhznyN81RycRe9qXMQ0Z

version: 0.9.10.{build}
build_script:
- ps: |
    # Check Version of PowerShell
    $PSVersionTable

    # Initialise
    . .\CICD\BuildHelpers.ps1
    $agent = New-BuildAgent

    # Build Actions
    $agent.SetBuildNumber()
    write-Host "Manifest version updated to: " ($agent.GetManifestVersion()[0])

test_script:
- ps: |
    # Check Version of PowerShell
    $PSVersionTable

    # Initialise
    . .\CICD\BuildHelpers.ps1
    Install-Module -Name Pester -Force
    Import-Module Pester -MinimumVersion 5.0.0
    
    # Testing Actions
    $config = New-PesterCIConfiguration -IgnoreRemoteFilesystem -MSWordNotAvailable -IncludeCoverage -IncludeResults -IncludeDetail 
    $result = Invoke-Pester -Configuration $config
    $agent = New-BuildAgent
    $agent.SetAutomationCoverageBadge($result)
    (New-Object 'System.Net.WebClient').UploadFile("https://ci.appveyor.com/api/testresults/nunit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path $config.TestResult.OutputPath.Value))

    # Status
    $env:TEST_FAIL_COUNT=$result.FailedCount

- git config --global credential.helper store
- ps: Add-Content "$HOME\.git-credentials" "https://$($env:GitHubAccessToken):x-oauth-basic@github.com`n"
- git config --global user.email "build@appveyor.com"
- git config --global user.name "Appveyor"
- git checkout %APPVEYOR_REPO_BRANCH%
- git add *.psd1
- git add *.md
- git commit -m "[skip ci] AppVeyor CI %APPVEYOR_BUILD_VERSION%"
- git push --set-upstream origin %APPVEYOR_REPO_BRANCH%

after_test:
- ps: |
    if ( $env:TEST_FAIL_COUNT -gt 0) { throw "$($env:TEST_FAIL_COUNT) tests failed." } else { Write-Host "All tests passed." }
